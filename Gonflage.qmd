---
title: "Préparation des mélanges"
filters:
  - shinylive
---

## Préparation de bails out

Que faire quand on dispose de relais contenant des nitrox et qu'on veut les gonfler à un mélange précis pour faire des bails-out peu riches ?

```{shinylive-r}
#| standalone: true
#| viewerHeight: 350

library(shiny)
library(bslib)
library(tidyverse)

ui <- fluidPage(# Your UI components go here
  ui <- page_sidebar(
    sidebar = sidebar(
      open = "always",
      numericInput("gaz_bloc", "Pourcentage d'O2 actuellement dans le bloc", 45),
      numericInput("gaz_final", "Pourcentage d'O2 souhaité après gonflage", 30),
      numericInput("pression_finale", "Pression finale du bloc", 220),
    ),
    textOutput("out")
  ))

server <- function(input, output, session) {
  # Fonction qui permet de calculer la pression à laquelle redescendre un bloc de nitrox pour l'amener à un mélange précis en complétant à l'air
  # gaz.bloc : quel est le pourcentage d'oxygène dans le gaz du bloc à compléter ?
  # pression.bloc : quelle est la pression dans le bloc à compléter (avant de compléter !)
  # gaz.final : quelle est le pourcentage d'oxygène souhaité au final ? 
  # pression.finale : quelle est la pression finale souhaitée après avoir complété.
  
  resultat <- reactive({
    
    vol_final <- input$gaz_final * input$pression_finale
    
    tbl <- tibble(added_air_bars = 0 : input$pression_finale,
                  nitrox_bars = input$pression_finale - added_air_bars) |> 
      mutate(vO2_ajout = 21 * added_air_bars,
             vO2_nitrox  = input$gaz_bloc * nitrox_bars,
             vO2_total   = vO2_ajout + vO2_nitrox,
             volume_diff = abs(vO2_total - vol_final),
             compo_finale = vO2_total / input$pression_finale) |> 
      filter(volume_diff == min(volume_diff)) |> 
      slice_min(added_air_bars)
    
    if (input$gaz_bloc <= input$gaz_final) {
      out <- "Le pourcentage d'oxygène final doit être inférieur au pourcentage d'oxygène actuel"
    } else if (tbl$added_air_bars > input$pression_finale) {
      out <- "Il n'est pas possible de compléter le bloc avec les valeurs fournies"
    } else {
      out <- paste0("Descendez le bloc jusqu'à ", tbl$nitrox_bars, " bars puis compétez à l'air jusqu'à ", input$pression_finale, " bars pour obtenir un nitrox ", round(tbl$compo_finale,1))
    }
    
    return(out)
    
  })
  
  output$out <- renderText(resultat())
}


# Create and launch the Shiny app
shinyApp(ui, server)

```